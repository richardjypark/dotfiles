#!/usr/bin/env bash
set -euo pipefail
. "$HOME/.local/lib/chezmoi-helpers.sh"

NVM_DIR="$HOME/.nvm"

# Use chezmoi template syntax with proper spacing
{{- with .nvm }}
NVM_VERSION="{{ .version }}"
NODE_VERSION="{{ .nodeVersion }}"
{{- end }}

# Keep state key filesystem-safe (for values like lts/*).
NODE_VERSION_STATE="${NODE_VERSION//\//_}"
NODE_VERSION_STATE="${NODE_VERSION_STATE//\*/_}"
NODE_STATE="node-setup-nvm${NVM_VERSION}-${NODE_VERSION_STATE}"

# Setup Node.js via NVM
vecho "Setting up Node.js via NVM..."

# Verify that chezmoi has properly cloned the repository
if [ ! -d "$NVM_DIR" ] || [ ! -f "$NVM_DIR/nvm.sh" ]; then
    eecho "Error: NVM repository not properly initialized at $NVM_DIR"
    eecho "This might indicate that chezmoi external file setup hasn't completed yet."
    eecho "Try running 'chezmoi apply --refresh-externals' first."
    exit 1
fi

# Load NVM
. "$NVM_DIR/nvm.sh"

resolve_node_version() {
    local requested="$1"
    local resolved=""

    resolved="$(nvm version "$requested" 2>/dev/null || true)"
    if [ -n "$resolved" ] && [ "$resolved" != "N/A" ]; then
        printf '%s\n' "$resolved"
        return 0
    fi

    resolved="$(nvm version-remote "$requested" 2>/dev/null || true)"
    if [ -n "$resolved" ] && [ "$resolved" != "N/A" ]; then
        printf '%s\n' "$resolved"
        return 0
    fi

    return 1
}

# Determine if the requested Node version is already installed in NVM.
# `nvm current` can be "none/system" in non-interactive apply runs.
CURRENT_NODE_VERSION="$(nvm version "$NODE_VERSION" 2>/dev/null || true)"
if [ -z "$CURRENT_NODE_VERSION" ] || [ "$CURRENT_NODE_VERSION" = "N/A" ]; then
    CURRENT_NODE_VERSION="N/A"
fi

TARGET_NODE_VERSION="$CURRENT_NODE_VERSION"
if [ "$TARGET_NODE_VERSION" = "N/A" ]; then
    if ! TARGET_NODE_VERSION="$(resolve_node_version "$NODE_VERSION")"; then
        eecho "Error: Failed to resolve Node.js version '$NODE_VERSION' via NVM"
        eecho "Run 'nvm ls-remote --lts' to verify remote resolution, then rerun chezmoi apply."
        exit 1
    fi
fi

if should_skip_state "$NODE_STATE"; then
    STATE_NODE_PATH="$(nvm which "$TARGET_NODE_VERSION" 2>/dev/null || true)"
    if [ -n "$STATE_NODE_PATH" ] && [ -x "$STATE_NODE_PATH" ]; then
        STATE_NODE_BIN="$(dirname "$STATE_NODE_PATH")"
        if [ -x "$STATE_NODE_BIN/npm" ]; then
            vecho "Node.js setup already completed (state tracked)"
            exit 0
        fi
    fi
    vecho "Node.js state exists but install is incomplete; re-running setup."
fi

NEED_NODE_INSTALL=false
if [ "$CURRENT_NODE_VERSION" = "N/A" ]; then
    NEED_NODE_INSTALL=true
fi

if [ "$NEED_NODE_INSTALL" = "true" ]; then
    if [ "$TARGET_NODE_VERSION" = "$NODE_VERSION" ]; then
        eecho "Installing Node.js $TARGET_NODE_VERSION..."
    else
        eecho "Installing Node.js $TARGET_NODE_VERSION (requested: $NODE_VERSION)..."
    fi
    run_quiet nvm install "$TARGET_NODE_VERSION"
else
    vecho "Node.js $CURRENT_NODE_VERSION is already installed"
fi

# Keep default alias aligned with the concrete installed version so `nvm use default`
# does not fall back to an unresolved symbolic alias such as `lts/*`.
nvm alias default "$TARGET_NODE_VERSION" >/dev/null 2>&1

# Ensure current shell resolves tools from active NVM Node, not external shims.
nvm use "$TARGET_NODE_VERSION" >/dev/null 2>&1

NVM_BIN="${NVM_BIN:-}"
if [ -z "$NVM_BIN" ] || [ ! -x "$NVM_BIN/npm" ]; then
    CURRENT_NVM_NODE=$(nvm which "$TARGET_NODE_VERSION" 2>/dev/null || true)
    if [ -n "$CURRENT_NVM_NODE" ] && [ -x "$CURRENT_NVM_NODE" ]; then
        NVM_BIN=$(dirname "$CURRENT_NVM_NODE")
    fi
fi

if [ -z "$NVM_BIN" ] || [ ! -x "$NVM_BIN/node" ] || [ ! -x "$NVM_BIN/npm" ]; then
    eecho "Error: Failed to resolve Node.js/npm from NVM at $NVM_DIR"
    eecho "Try running 'chezmoi apply --refresh-externals' first."
    exit 1
fi

export PATH="$NVM_BIN:$PATH"
hash -r 2>/dev/null || true
NODE_CMD="$NVM_BIN/node"
NPM_CMD="$NVM_BIN/npm"

# Install global packages only if needed
vecho "Checking global npm packages..."
PACKAGES_TO_INSTALL=()
for package in yarn pnpm; do
    if ! "$NPM_CMD" list -g --depth=0 "$package" >/dev/null 2>&1; then
        PACKAGES_TO_INSTALL+=("$package")
    else
        vecho "$package is already installed in NVM globals"
    fi
done

# Install all missing packages in one go
if [ "${#PACKAGES_TO_INSTALL[@]}" -gt 0 ]; then
    eecho "Installing packages: ${PACKAGES_TO_INSTALL[*]}"
    if ! "$NPM_CMD" -v >/dev/null 2>&1; then
        eecho "Error: npm is unavailable from NVM bin ($NPM_CMD)"
        exit 1
    fi
    run_quiet "$NPM_CMD" install -g "${PACKAGES_TO_INSTALL[@]}"
fi

# Create a simple test to verify everything is working (only if verbose)
if [ "$VERBOSE" = "true" ]; then
    echo "\nVerifying Node.js ecosystem installation:"
    echo "----------------------------------------"
    echo "Node.js version:    $("$NODE_CMD" -v)"
    echo "npm version:        $("$NPM_CMD" -v)"
    if is_installed yarn; then
        echo "Yarn version:       $(yarn -v)"
    fi
    if is_installed pnpm; then
        echo "pnpm version:       $(pnpm -v)"
    fi
    echo "----------------------------------------"
    echo "\nNode.js setup complete!"
fi

mark_state "$NODE_STATE"
