#!/usr/bin/env bash
set -euo pipefail
. "$HOME/.local/lib/chezmoi-helpers.sh"

# Setup Node.js via NVM
vecho "Setting up Node.js via NVM..."
NVM_DIR="$HOME/.nvm"

# Use chezmoi template syntax with proper spacing
{{- with .nvm }}
NVM_VERSION="{{ .version }}"
NODE_VERSION="{{ .nodeVersion }}"
{{- end }}

# Verify that chezmoi has properly cloned the repository
if [ ! -d "$NVM_DIR" ] || [ ! -f "$NVM_DIR/nvm.sh" ]; then
    eecho "Error: NVM repository not properly initialized at $NVM_DIR"
    eecho "This might indicate that chezmoi external file setup hasn't completed yet."
    eecho "Try running 'chezmoi apply --refresh-externals' first."
    exit 1
fi

# Load NVM
. "$NVM_DIR/nvm.sh"

# Determine if the requested Node version is already installed in NVM.
# `nvm current` can be "none/system" in non-interactive apply runs.
CURRENT_NODE_VERSION=$(nvm version "$NODE_VERSION" 2>/dev/null || echo "N/A")
NEED_NODE_INSTALL=false
if [ "$CURRENT_NODE_VERSION" = "N/A" ]; then
    NEED_NODE_INSTALL=true
fi

if [ "$NEED_NODE_INSTALL" = "true" ]; then
    eecho "Installing Node.js $NODE_VERSION..."
    if [ "$VERBOSE" = "true" ]; then
        nvm install "$NODE_VERSION"
    else
        nvm install "$NODE_VERSION" >/dev/null 2>&1
    fi
else
    vecho "Node.js $CURRENT_NODE_VERSION is already installed and set as default"
fi

# Keep default alias aligned with requested version without forcing reinstall.
if [ "$VERBOSE" = "true" ]; then
    nvm alias default "$NODE_VERSION" >/dev/null
else
    nvm alias default "$NODE_VERSION" >/dev/null 2>&1
fi

# Ensure current shell resolves tools from active NVM Node, not external shims.
if [ "$VERBOSE" = "true" ]; then
    nvm use default >/dev/null
else
    nvm use default >/dev/null 2>&1
fi

NVM_BIN="${NVM_BIN:-}"
if [ -z "$NVM_BIN" ] || [ ! -x "$NVM_BIN/npm" ]; then
    CURRENT_NVM_NODE=$(nvm which current 2>/dev/null || true)
    if [ -n "$CURRENT_NVM_NODE" ] && [ -x "$CURRENT_NVM_NODE" ]; then
        NVM_BIN=$(dirname "$CURRENT_NVM_NODE")
    fi
fi

if [ -z "$NVM_BIN" ] || [ ! -x "$NVM_BIN/node" ] || [ ! -x "$NVM_BIN/npm" ]; then
    eecho "Error: Failed to resolve Node.js/npm from NVM at $NVM_DIR"
    eecho "Try running 'chezmoi apply --refresh-externals' first."
    exit 1
fi

export PATH="$NVM_BIN:$PATH"
hash -r 2>/dev/null || true
NODE_CMD="$NVM_BIN/node"
NPM_CMD="$NVM_BIN/npm"

# Install global packages only if needed
vecho "Checking global npm packages..."
PACKAGES_TO_INSTALL=()
for package in yarn pnpm; do
    if ! "$NPM_CMD" list -g --depth=0 "$package" >/dev/null 2>&1; then
        PACKAGES_TO_INSTALL+=("$package")
    else
        vecho "$package is already installed in NVM globals"
    fi
done

# Install all missing packages in one go
if [ "${#PACKAGES_TO_INSTALL[@]}" -gt 0 ]; then
    eecho "Installing packages: ${PACKAGES_TO_INSTALL[*]}"
    if ! "$NPM_CMD" -v >/dev/null 2>&1; then
        eecho "Error: npm is unavailable from NVM bin ($NPM_CMD)"
        exit 1
    fi
    if [ "$VERBOSE" = "true" ]; then
        "$NPM_CMD" install -g "${PACKAGES_TO_INSTALL[@]}"
    else
        "$NPM_CMD" install -g "${PACKAGES_TO_INSTALL[@]}" >/dev/null 2>&1
    fi
fi

# Create a simple test to verify everything is working (only if verbose)
if [ "$VERBOSE" = "true" ]; then
    echo "\nVerifying Node.js ecosystem installation:"
    echo "----------------------------------------"
    echo "Node.js version:    $("$NODE_CMD" -v)"
    echo "npm version:        $("$NPM_CMD" -v)"
    if is_installed yarn; then
        echo "Yarn version:       $(yarn -v)"
    fi
    if is_installed pnpm; then
        echo "pnpm version:       $(pnpm -v)"
    fi
    echo "----------------------------------------"
    echo "\nNode.js setup complete!"
fi
