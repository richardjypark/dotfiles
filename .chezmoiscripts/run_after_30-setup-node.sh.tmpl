#!/bin/sh
set -e

# Setup Node.js via NVM
echo "Setting up Node.js via NVM..."
NVM_DIR="$HOME/.nvm"

# Use chezmoi template syntax with proper spacing
{{- with .nvm }}
NVM_VERSION="{{ .version }}"
NODE_VERSION="{{ .nodeVersion }}"
{{- end }}

# Verify that chezmoi has properly cloned the repository
if [ ! -d "$NVM_DIR" ] || [ ! -f "$NVM_DIR/nvm.sh" ]; then
    echo "Error: NVM repository not properly initialized at $NVM_DIR"
    echo "This might indicate that chezmoi external file setup hasn't completed yet."
    echo "Try running 'chezmoi apply --refresh-externals' first."
    exit 1
fi

# Load NVM
. "$NVM_DIR/nvm.sh"

# Install specified Node version if not already installed
if ! nvm which "$NODE_VERSION" >/dev/null 2>&1; then
    echo "Installing Node.js $NODE_VERSION..."
    nvm install "$NODE_VERSION"
    nvm alias default "$NODE_VERSION"
fi

# Use the default version
nvm use default >/dev/null

# Verify node is available
if ! command -v node >/dev/null 2>&1; then
    echo "Error: Node.js installation failed"
    exit 1
fi

# Install essential global packages
echo "Installing essential global npm packages..."
npm install -g npm@latest >/dev/null 2>&1 # Update npm itself
npm install -g yarn >/dev/null 2>&1
npm install -g pnpm >/dev/null 2>&1

# Verify installation
NODE_VERSION=$(node --version)
NPM_VERSION=$(npm --version)
YARN_VERSION=$(yarn --version)
PNPM_VERSION=$(pnpm --version)

echo "Node.js setup complete!"
echo "Node.js version: $NODE_VERSION"
echo "npm version: $NPM_VERSION"
echo "yarn version: $YARN_VERSION"
echo "pnpm version: $PNPM_VERSION"

# Add helpful message about shell restart
echo "\nIMPORTANT: To use Node.js in your current session, either:"
echo "1. Restart your shell:    exec zsh"
echo "2. Or source NVM:         source ~/.nvm/nvm.sh"
