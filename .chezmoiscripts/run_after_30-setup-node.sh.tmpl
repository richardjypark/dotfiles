#!/usr/bin/env bash
set -euo pipefail
. "$HOME/.local/lib/chezmoi-helpers.sh"

# Setup Node.js via NVM
vecho "Setting up Node.js via NVM..."
NVM_DIR="$HOME/.nvm"
FORCE_UPDATE="${CHEZMOI_FORCE_UPDATE:-0}"

# Use chezmoi template syntax with proper spacing
{{- with .nvm }}
NVM_VERSION="{{ .version }}"
NODE_VERSION="{{ .nodeVersion }}"
{{- end }}

# Fast exit if Node.js is already properly set up
if [ "$FORCE_UPDATE" != "1" ] && [ -f "$NVM_DIR/nvm.sh" ] && is_installed node; then
    . "$NVM_DIR/nvm.sh" >/dev/null 2>&1
    CURRENT_NODE_VERSION=$(nvm current 2>/dev/null || echo "none")

    # Handle LTS version comparison
    if [ "$NODE_VERSION" = "lts/*" ]; then
        # For LTS, check if current version is an LTS version (even numbers)
        if echo "$CURRENT_NODE_VERSION" | grep -q "^v[0-9]*[02468]\." && [ "$CURRENT_NODE_VERSION" != "none" ]; then
            NODE_SETUP_COMPLETE=true
        else
            NODE_SETUP_COMPLETE=false
        fi
    else
        # For specific versions, do exact match
        if [ "$CURRENT_NODE_VERSION" = "$NODE_VERSION" ]; then
            NODE_SETUP_COMPLETE=true
        else
            NODE_SETUP_COMPLETE=false
        fi
    fi

    if [ "$NODE_SETUP_COMPLETE" = "true" ]; then
        # Quick check for global packages and runtime health
        if is_installed yarn && is_installed pnpm \
            && node --version >/dev/null 2>&1 \
            && npm --version >/dev/null 2>&1; then
            vecho "Node.js and packages are already installed and configured"
            exit 0
        else
            vecho "Node.js appears installed, but npm/package health check failed; re-running setup..."
        fi
    fi
fi

# Verify that chezmoi has properly cloned the repository
if [ ! -d "$NVM_DIR" ] || [ ! -f "$NVM_DIR/nvm.sh" ]; then
    eecho "Error: NVM repository not properly initialized at $NVM_DIR"
    eecho "This might indicate that chezmoi external file setup hasn't completed yet."
    eecho "Try running 'chezmoi apply --refresh-externals' first."
    exit 1
fi

# Load NVM
. "$NVM_DIR/nvm.sh"

# Check if the correct Node version is already installed and set as default
CURRENT_NODE_VERSION=$(nvm current 2>/dev/null || echo "none")

# Determine if we need to install/switch Node version
NEED_NODE_INSTALL=false
if [ "$NODE_VERSION" = "lts/*" ]; then
    # For LTS, check if current version is an LTS version
    if ! echo "$CURRENT_NODE_VERSION" | grep -q "^v[0-9]*[02468]\." || [ "$CURRENT_NODE_VERSION" = "none" ]; then
        NEED_NODE_INSTALL=true
    fi
else
    # For specific versions, do exact match
    if [ "$CURRENT_NODE_VERSION" != "$NODE_VERSION" ]; then
        NEED_NODE_INSTALL=true
    fi
fi

if [ "$NEED_NODE_INSTALL" = "true" ]; then
    eecho "Installing Node.js $NODE_VERSION..."
    if [ "$VERBOSE" = "true" ]; then
        nvm install "$NODE_VERSION"
        nvm alias default "$NODE_VERSION"
        nvm use default
    else
        nvm install "$NODE_VERSION" >/dev/null 2>&1
        nvm alias default "$NODE_VERSION" >/dev/null 2>&1
        nvm use default >/dev/null 2>&1
    fi
else
    vecho "Node.js $CURRENT_NODE_VERSION is already installed and set as default"
fi

# Ensure current shell resolves tools from active NVM Node, not external shims.
if [ "$VERBOSE" = "true" ]; then
    nvm use default >/dev/null
else
    nvm use default >/dev/null 2>&1
fi

NVM_BIN="${NVM_BIN:-}"
if [ -z "$NVM_BIN" ] || [ ! -x "$NVM_BIN/npm" ]; then
    CURRENT_NVM_NODE=$(nvm which current 2>/dev/null || true)
    if [ -n "$CURRENT_NVM_NODE" ] && [ -x "$CURRENT_NVM_NODE" ]; then
        NVM_BIN=$(dirname "$CURRENT_NVM_NODE")
    fi
fi

if [ -z "$NVM_BIN" ] || [ ! -x "$NVM_BIN/node" ] || [ ! -x "$NVM_BIN/npm" ]; then
    eecho "Error: Failed to resolve Node.js/npm from NVM at $NVM_DIR"
    eecho "Try running 'chezmoi apply --refresh-externals' first."
    exit 1
fi

export PATH="$NVM_BIN:$PATH"
hash -r 2>/dev/null || true
NODE_CMD="$NVM_BIN/node"
NPM_CMD="$NVM_BIN/npm"

# Install global packages only if needed
vecho "Checking global npm packages..."
PACKAGES_TO_INSTALL=()
for package in yarn pnpm; do
    if ! is_installed "$package"; then
        PACKAGES_TO_INSTALL+=("$package")
    else
        vecho "$package is already installed"
    fi
done

# Install all missing packages in one go
if [ "${#PACKAGES_TO_INSTALL[@]}" -gt 0 ]; then
    eecho "Installing packages: ${PACKAGES_TO_INSTALL[*]}"
    if ! "$NPM_CMD" -v >/dev/null 2>&1; then
        eecho "Error: npm is unavailable from NVM bin ($NPM_CMD)"
        exit 1
    fi
    if [ "$VERBOSE" = "true" ]; then
        "$NPM_CMD" install -g "${PACKAGES_TO_INSTALL[@]}"
    else
        "$NPM_CMD" install -g "${PACKAGES_TO_INSTALL[@]}" >/dev/null 2>&1
    fi
fi

# Create a simple test to verify everything is working (only if verbose)
if [ "$VERBOSE" = "true" ]; then
    echo "\nVerifying Node.js ecosystem installation:"
    echo "----------------------------------------"
    echo "Node.js version:    $("$NODE_CMD" -v)"
    echo "npm version:        $("$NPM_CMD" -v)"
    if is_installed yarn; then
        echo "Yarn version:       $(yarn -v)"
    fi
    if is_installed pnpm; then
        echo "pnpm version:       $(pnpm -v)"
    fi
    echo "----------------------------------------"
    echo "\nNode.js setup complete!"
fi
