#!/usr/bin/env bash
set -euo pipefail
. "$HOME/.local/lib/chezmoi-helpers.sh"

vecho "Setting up uv (Python package manager)..."

UV_DIR="$HOME/.local/bin"
add_to_path "$UV_DIR"
CACHE_DIR="${CHEZMOI_DOWNLOAD_CACHE_DIR:-$HOME/.cache/chezmoi-downloads}"

# Use chezmoi template syntax to read Python version
{{- with .python }}
PYTHON_VERSION="{{ .version }}"
{{- else }}
PYTHON_VERSION="3.12"
{{- end }}

{{- with .pinned.uv }}
PINNED_UV_VERSION="{{ .version }}"
PINNED_UV_LINUX_X86_64_SHA="{{ .linux_x86_64_sha256 }}"
PINNED_UV_LINUX_ARM64_SHA="{{ .linux_arm64_sha256 }}"
PINNED_UV_MACOS_X86_64_SHA="{{ .macos_x86_64_sha256 }}"
PINNED_UV_MACOS_ARM64_SHA="{{ .macos_arm64_sha256 }}"
{{- end }}

# Check if uv is already installed
if ! is_force_update && is_installed uv; then
    vecho "uv is already installed: $(uv --version)"
else
    # Ensure .local/bin exists
    mkdir -p "$UV_DIR"
    if ! require_trust_for_remote_download "github.com/astral-sh/uv"; then
        exit 1
    fi

    platform=""
    archive_name=""
    expected_sha=""

    if ! platform="$(platform_key)"; then
        exit 1
    fi

    case "$platform" in
        linux-x86_64)
            archive_name="uv-x86_64-unknown-linux-gnu.tar.gz"
            expected_sha="$PINNED_UV_LINUX_X86_64_SHA"
            ;;
        linux-arm64)
            archive_name="uv-aarch64-unknown-linux-gnu.tar.gz"
            expected_sha="$PINNED_UV_LINUX_ARM64_SHA"
            ;;
        macos-x86_64)
            archive_name="uv-x86_64-apple-darwin.tar.gz"
            expected_sha="$PINNED_UV_MACOS_X86_64_SHA"
            ;;
        macos-arm64)
            archive_name="uv-aarch64-apple-darwin.tar.gz"
            expected_sha="$PINNED_UV_MACOS_ARM64_SHA"
            ;;
        *)
            eecho "Unsupported platform for uv installation: ${os}-${arch}"
            exit 1
            ;;
    esac

    download_url="https://github.com/astral-sh/uv/releases/download/${PINNED_UV_VERSION}/${archive_name}"
    cache_file="$CACHE_DIR/uv-${PINNED_UV_VERSION}-${platform}.tar.gz"
    temp_dir="$(mktemp -d)"
    trap 'rm -rf "$temp_dir"' RETURN

    eecho "Installing uv from pinned release binary (${PINNED_UV_VERSION})..."
    download_and_verify "$download_url" "$cache_file" "$expected_sha"
    cp "$cache_file" "$temp_dir/uv.tar.gz"
    tar -xzf "$temp_dir/uv.tar.gz" -C "$temp_dir"

    uv_binary="$(find "$temp_dir" -maxdepth 3 -type f -name uv | head -1)"
    if [ -z "$uv_binary" ]; then
        eecho "Error: uv binary not found in release archive."
        exit 1
    fi
    install -m 755 "$uv_binary" "$UV_DIR/uv"

    # Verify installation
    if is_installed uv || [ -x "$UV_DIR/uv" ]; then
        if [ "$VERBOSE" = "true" ]; then
            echo "uv installed successfully: $(uv --version 2>/dev/null || $UV_DIR/uv --version)"
        fi
    else
        eecho "Warning: uv installation may have failed. Check manually."
        exit 1
    fi
fi

# Check if Python is already installed via uv
if ! is_force_update && uv python list 2>/dev/null | grep -q "$PYTHON_VERSION"; then
    vecho "Python $PYTHON_VERSION is already installed via uv"
    exit 0
fi

# Install Python via uv
vecho "Installing Python $PYTHON_VERSION via uv..."
if [ "$VERBOSE" = "true" ]; then
    uv python install "$PYTHON_VERSION"
else
    uv python install "$PYTHON_VERSION" >/dev/null 2>&1
fi

# Verify Python installation
if uv python list 2>/dev/null | grep -q "$PYTHON_VERSION"; then
    if [ "$VERBOSE" = "true" ]; then
        echo "Python $PYTHON_VERSION installed successfully via uv"
        uv python list
    fi
else
    eecho "Warning: Python $PYTHON_VERSION installation may have failed. Check manually."
fi

vecho "uv and Python setup complete!"
