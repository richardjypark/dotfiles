#!/usr/bin/env bash
set -euo pipefail
. "$HOME/.local/lib/chezmoi-helpers.sh"

UV_DIR="$HOME/.local/bin"
add_to_path "$UV_DIR"
CACHE_DIR="${CHEZMOI_DOWNLOAD_CACHE_DIR:-$HOME/.cache/chezmoi-downloads}"

# Use chezmoi template syntax to read Python version
{{- with .python }}
PYTHON_VERSION="{{ .version }}"
{{- else }}
PYTHON_VERSION="3.12"
{{- end }}

{{- with .pinned.uv }}
PINNED_UV_VERSION="{{ .version }}"
PINNED_UV_LINUX_X86_64_SHA="{{ .linux_x86_64_sha256 }}"
PINNED_UV_LINUX_ARM64_SHA="{{ .linux_arm64_sha256 }}"
PINNED_UV_MACOS_X86_64_SHA="{{ .macos_x86_64_sha256 }}"
PINNED_UV_MACOS_ARM64_SHA="{{ .macos_arm64_sha256 }}"
{{- end }}

UV_STATE="uv-setup-${PINNED_UV_VERSION}-py${PYTHON_VERSION}"

if should_skip_state "$UV_STATE" && is_installed uv; then
    if uv python list 2>/dev/null | grep -q "$PYTHON_VERSION"; then
        vecho "uv setup already completed (state tracked)"
        exit 0
    fi
    vecho "uv state exists but Python $PYTHON_VERSION is missing; re-running setup."
fi

vecho "Setting up uv (Python package manager)..."

resolve_brew_cmd() {
    if command -v brew >/dev/null 2>&1; then
        command -v brew
        return 0
    fi

    if [ -x /opt/homebrew/bin/brew ]; then
        printf '%s\n' "/opt/homebrew/bin/brew"
        return 0
    fi

    if [ -x /usr/local/bin/brew ]; then
        printf '%s\n' "/usr/local/bin/brew"
        return 0
    fi

    return 1
}

install_uv_from_pinned_release() {
    local platform="$1"
    local archive_name=""
    local expected_sha=""
    local download_url=""
    local cache_file=""
    local temp_dir=""
    local uv_binary=""

    if ! require_trust_for_remote_download "github.com/astral-sh/uv"; then
        return 1
    fi

    case "$platform" in
        linux-x86_64)
            archive_name="uv-x86_64-unknown-linux-gnu.tar.gz"
            expected_sha="$PINNED_UV_LINUX_X86_64_SHA"
            ;;
        linux-arm64)
            archive_name="uv-aarch64-unknown-linux-gnu.tar.gz"
            expected_sha="$PINNED_UV_LINUX_ARM64_SHA"
            ;;
        macos-x86_64)
            archive_name="uv-x86_64-apple-darwin.tar.gz"
            expected_sha="$PINNED_UV_MACOS_X86_64_SHA"
            ;;
        macos-arm64)
            archive_name="uv-aarch64-apple-darwin.tar.gz"
            expected_sha="$PINNED_UV_MACOS_ARM64_SHA"
            ;;
        *)
            eecho "Unsupported platform for uv installation: ${platform}"
            return 1
            ;;
    esac

    download_url="https://github.com/astral-sh/uv/releases/download/${PINNED_UV_VERSION}/${archive_name}"
    cache_file="$CACHE_DIR/uv-${PINNED_UV_VERSION}-${platform}.tar.gz"
    temp_dir="$(mktemp -d)"
    trap 'rm -rf "$temp_dir"' RETURN

    eecho "Installing uv from pinned release binary (${PINNED_UV_VERSION})..."
    download_and_verify "$download_url" "$cache_file" "$expected_sha"
    cp "$cache_file" "$temp_dir/uv.tar.gz"
    tar -xzf "$temp_dir/uv.tar.gz" -C "$temp_dir"

    uv_binary="$(find "$temp_dir" -maxdepth 3 -type f -name uv | head -1)"
    if [ -z "$uv_binary" ]; then
        eecho "Error: uv binary not found in release archive."
        return 1
    fi

    install -m 755 "$uv_binary" "$UV_DIR/uv"

    if is_installed uv || [ -x "$UV_DIR/uv" ]; then
        vecho "uv installed successfully: $(uv --version 2>/dev/null || $UV_DIR/uv --version)"
        return 0
    fi

    eecho "Warning: uv installation may have failed. Check manually."
    return 1
}

# Check if uv is already installed
if is_installed uv; then
    vecho "uv is already installed: $(uv --version)"
else
    # Ensure .local/bin exists
    mkdir -p "$UV_DIR"

    platform=""
    brew_cmd=""

    if ! platform="$(platform_key)"; then
        exit 1
    fi

    case "$platform" in
        macos-*)
            if brew_cmd="$(resolve_brew_cmd)"; then
                eecho "Installing uv via Homebrew..."
                "$brew_cmd" install uv

                # Ensure uv is discoverable in non-login shell PATH.
                if ! is_installed uv; then
                    brew_prefix="$("$brew_cmd" --prefix 2>/dev/null || true)"
                    if [ -n "$brew_prefix" ] && [ -x "$brew_prefix/bin/uv" ]; then
                        ln -sf "$brew_prefix/bin/uv" "$UV_DIR/uv"
                    fi
                fi

                if ! is_installed uv; then
                    eecho "Error: uv is not available after Homebrew installation."
                    exit 1
                fi
            else
                vecho "Homebrew not found; falling back to pinned uv release binary."
                if ! install_uv_from_pinned_release "$platform"; then
                    exit 1
                fi
            fi
            ;;
        linux-*)
            if ! install_uv_from_pinned_release "$platform"; then
                exit 1
            fi
            ;;
        *)
            eecho "Unsupported platform for uv installation: ${platform}"
            exit 1
            ;;
    esac
fi

# Check if Python is already installed via uv
if uv python list 2>/dev/null | grep -q "$PYTHON_VERSION"; then
    vecho "Python $PYTHON_VERSION is already installed via uv"
    mark_state "$UV_STATE"
    exit 0
fi

# Install Python via uv
vecho "Installing Python $PYTHON_VERSION via uv..."
run_quiet uv python install "$PYTHON_VERSION"

# Verify Python installation
if uv python list 2>/dev/null | grep -q "$PYTHON_VERSION"; then
    vecho "Python $PYTHON_VERSION installed successfully via uv"
    if [ "$VERBOSE" = "true" ]; then
        uv python list
    fi
    mark_state "$UV_STATE"
    vecho "uv and Python setup complete!"
else
    eecho "Error: Python $PYTHON_VERSION installation failed verification."
    exit 1
fi
