#!/usr/bin/env bash
set -euo pipefail

# Use loader pattern: finds helpers from applied target or source dir fallback.
CHEZMOI_SOURCE_DIR="${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path 2>/dev/null || true)}"
if [ -z "$CHEZMOI_SOURCE_DIR" ]; then
    CHEZMOI_SOURCE_DIR="$HOME/.local/share/chezmoi"
fi
# shellcheck disable=SC1090
. "$CHEZMOI_SOURCE_DIR/scripts/lib/load-helpers.sh"

# Minimal safety net: should_skip_state/is_force_update may not exist on very
# first bootstrap before helpers are applied (consistent with other run_before_* scripts).
if ! command -v should_skip_state >/dev/null 2>&1; then
    should_skip_state() {
        local state_name="$1"
        if [ -f "${STATE_DIR:-$HOME/.cache/chezmoi-state}/${state_name}.done" ] && ! is_force_update; then
            return 0
        fi
        return 1
    }
fi
if ! command -v is_force_update >/dev/null 2>&1; then
    is_force_update() {
        [ "${CHEZMOI_FORCE_UPDATE:-0}" = "1" ]
    }
fi

PREFETCH_STATE="prefetch-assets"
CACHE_DIR="${CHEZMOI_DOWNLOAD_CACHE_DIR:-$HOME/.cache/chezmoi-downloads}"
MAX_JOBS="${CHEZMOI_PREFETCH_JOBS:-4}"

{{- with .pinned.neovim }}
NVIM_VERSION="{{ .version }}"
NVIM_LINUX_X86_64_SHA="{{ .linux_x86_64_sha256 }}"
NVIM_LINUX_ARM64_SHA="{{ .linux_arm64_sha256 }}"
NVIM_MACOS_X86_64_SHA="{{ .macos_x86_64_sha256 }}"
NVIM_MACOS_ARM64_SHA="{{ .macos_arm64_sha256 }}"
{{- end }}

{{- with .pinned.jj }}
JJ_VERSION="{{ .version }}"
JJ_LINUX_X86_64_SHA="{{ .linux_x86_64_sha256 }}"
JJ_LINUX_ARM64_SHA="{{ .linux_arm64_sha256 }}"
JJ_MACOS_X86_64_SHA="{{ .macos_x86_64_sha256 }}"
JJ_MACOS_ARM64_SHA="{{ .macos_arm64_sha256 }}"
{{- end }}

{{- with .pinned.codex }}
CODEX_VERSION="{{ .version }}"
CODEX_LINUX_X86_64_SHA="{{ .linux_x86_64_sha256 }}"
CODEX_LINUX_ARM64_SHA="{{ .linux_arm64_sha256 }}"
CODEX_MACOS_X86_64_SHA="{{ .macos_x86_64_sha256 }}"
CODEX_MACOS_ARM64_SHA="{{ .macos_arm64_sha256 }}"
{{- end }}

mkdir -p "$CACHE_DIR"

if should_skip_state "$PREFETCH_STATE"; then
    vecho "Artifact prefetch already completed (state tracked)"
    exit 0
fi

if [ "${TRUST_ON_FIRST_USE_INSTALLERS:-0}" != "1" ]; then
    vecho "Skipping artifact prefetch (TRUST_ON_FIRST_USE_INSTALLERS != 1)"
    exit 0
fi

if ! platform="$(platform_key)"; then
    vecho "Skipping prefetch on unsupported platform: $(uname -s)/$(uname -m)"
    exit 0
fi

artifacts=()

add_artifact() {
    local name="$1"
    local url="$2"
    local sha="$3"
    local dest="$4"
    artifacts+=("${name}|${url}|${sha}|${dest}")
}

case "$platform" in
    linux-x86_64)
        add_artifact "neovim" "https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-x86_64.tar.gz" "$NVIM_LINUX_X86_64_SHA" "$CACHE_DIR/neovim-${NVIM_VERSION}-linux-x86_64.tar.gz"
        add_artifact "jj" "https://github.com/jj-vcs/jj/releases/download/${JJ_VERSION}/jj-${JJ_VERSION}-x86_64-unknown-linux-musl.tar.gz" "$JJ_LINUX_X86_64_SHA" "$CACHE_DIR/jj-${JJ_VERSION}-linux-x86_64.tar.gz"
        add_artifact "codex" "https://github.com/openai/codex/releases/download/${CODEX_VERSION}/codex-x86_64-unknown-linux-musl.tar.gz" "$CODEX_LINUX_X86_64_SHA" "$CACHE_DIR/codex-${CODEX_VERSION}-linux-x86_64.tar.gz"
        ;;
    linux-arm64)
        add_artifact "neovim" "https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-arm64.tar.gz" "$NVIM_LINUX_ARM64_SHA" "$CACHE_DIR/neovim-${NVIM_VERSION}-linux-arm64.tar.gz"
        add_artifact "jj" "https://github.com/jj-vcs/jj/releases/download/${JJ_VERSION}/jj-${JJ_VERSION}-aarch64-unknown-linux-musl.tar.gz" "$JJ_LINUX_ARM64_SHA" "$CACHE_DIR/jj-${JJ_VERSION}-linux-arm64.tar.gz"
        add_artifact "codex" "https://github.com/openai/codex/releases/download/${CODEX_VERSION}/codex-aarch64-unknown-linux-musl.tar.gz" "$CODEX_LINUX_ARM64_SHA" "$CACHE_DIR/codex-${CODEX_VERSION}-linux-arm64.tar.gz"
        ;;
    macos-x86_64)
        add_artifact "neovim" "https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-macos-x86_64.tar.gz" "$NVIM_MACOS_X86_64_SHA" "$CACHE_DIR/neovim-${NVIM_VERSION}-macos-x86_64.tar.gz"
        add_artifact "jj" "https://github.com/jj-vcs/jj/releases/download/${JJ_VERSION}/jj-${JJ_VERSION}-x86_64-apple-darwin.tar.gz" "$JJ_MACOS_X86_64_SHA" "$CACHE_DIR/jj-${JJ_VERSION}-macos-x86_64.tar.gz"
        add_artifact "codex" "https://github.com/openai/codex/releases/download/${CODEX_VERSION}/codex-x86_64-apple-darwin.tar.gz" "$CODEX_MACOS_X86_64_SHA" "$CACHE_DIR/codex-${CODEX_VERSION}-macos-x86_64.tar.gz"
        ;;
    macos-arm64)
        add_artifact "neovim" "https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-macos-arm64.tar.gz" "$NVIM_MACOS_ARM64_SHA" "$CACHE_DIR/neovim-${NVIM_VERSION}-macos-arm64.tar.gz"
        add_artifact "jj" "https://github.com/jj-vcs/jj/releases/download/${JJ_VERSION}/jj-${JJ_VERSION}-aarch64-apple-darwin.tar.gz" "$JJ_MACOS_ARM64_SHA" "$CACHE_DIR/jj-${JJ_VERSION}-macos-arm64.tar.gz"
        add_artifact "codex" "https://github.com/openai/codex/releases/download/${CODEX_VERSION}/codex-aarch64-apple-darwin.tar.gz" "$CODEX_MACOS_ARM64_SHA" "$CACHE_DIR/codex-${CODEX_VERSION}-macos-arm64.tar.gz"
        ;;
esac

if [ "${CHEZMOI_ROLE:-}" = "server" ]; then
    filtered=()
    for item in "${artifacts[@]}"; do
        case "$item" in
            codex*) ;;
            *) filtered+=("$item") ;;
        esac
    done
    artifacts=("${filtered[@]}")
fi

if [ "${#artifacts[@]}" -eq 0 ]; then
    vecho "No artifacts selected for prefetch"
    exit 0
fi

pids=()
jobs=0
failed=0

wait_one() {
    local pid="$1"
    if ! wait "$pid"; then
        failed=1
    fi
}

for item in "${artifacts[@]}"; do
    IFS='|' read -r name url sha dest <<EOF
$item
EOF
    (
        vecho "Prefetching ${name}: ${url}"
        require_trust_for_remote_download "$url"
        download_and_verify "$url" "$dest" "$sha"
    ) &
    pids+=("$!")
    jobs=$((jobs + 1))

    if [ "$jobs" -ge "$MAX_JOBS" ]; then
        wait_one "${pids[0]}"
        pids=("${pids[@]:1}")
        jobs=$((jobs - 1))
    fi
done

for pid in "${pids[@]}"; do
    wait_one "$pid"
done

if [ "$failed" -ne 0 ]; then
    eecho "Error: one or more artifact prefetch jobs failed."
    exit 1
fi

mark_state "$PREFETCH_STATE"
vecho "Artifact prefetch complete"
