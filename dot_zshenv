# ~/.zshenv - Loaded for ALL shells (interactive and non-interactive)
# This ensures Node.js tools (npm, pnpm, node) are available in IDE terminals

# Shell startup profiling (optional, enable with ZSH_PROFILE_STARTUP=1)
if [[ -n "$ZSH_PROFILE_STARTUP" ]]; then
    # Initialize profiling arrays and start time
    typeset -ga _zsh_profile_times
    _zsh_profile_start=$(python3 -c 'import time; print(int(time.time()*1000))' 2>/dev/null || echo 0)

    # Checkpoint function
    _zsh_profile_checkpoint() {
        local name="$1"
        local now=$(python3 -c 'import time; print(int(time.time()*1000))' 2>/dev/null || echo 0)
        _zsh_profile_times+=("$name:$now")
    }

    _zsh_profile_checkpoint "zshenv start"
fi

# PATH Management Strategy:
# - ~/.zshenv (this file): Sets only ~/.local/bin for ALL shells (interactive + non-interactive)
#   This ensures IDE terminals and scripts can find tools like jj, uv, node, npm, etc.
# - ~/.config/shell/path.sh: Manages full PATH with deduplication (loaded by ~/.zshrc)
#   This handles all other paths and ensures no duplicates accumulate

# Ensure ~/.local/bin is in PATH for tools like jj, uv, etc.
export PATH="$HOME/.local/bin:$PATH"

# NVM lazy loading - sourced on first use of nvm/node/npm/npx
export NVM_DIR="$HOME/.nvm"

if [ -s "$NVM_DIR/nvm.sh" ]; then
    _nvm_lazy_load() {
        unset -f nvm node npm npx
        source "$NVM_DIR/nvm.sh"
        [ -s "$NVM_DIR/bash_completion" ] && source "$NVM_DIR/bash_completion"
    }
    nvm()  { _nvm_lazy_load; nvm  "$@"; }
    node() { _nvm_lazy_load; node "$@"; }
    npm()  { _nvm_lazy_load; npm  "$@"; }
    npx()  { _nvm_lazy_load; npx  "$@"; }
fi

# Profile NVM setup (lazy wrappers only, no actual load)
[[ -n "$ZSH_PROFILE_STARTUP" ]] && typeset -f _zsh_profile_checkpoint >/dev/null && _zsh_profile_checkpoint "nvm lazy wrappers defined"

# Bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# Cargo/Rust
[ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"

# uv (Python package manager) - may set additional variables
[ -f "$HOME/.local/bin/env" ] && . "$HOME/.local/bin/env"

# Profile zshenv completion
[[ -n "$ZSH_PROFILE_STARTUP" ]] && typeset -f _zsh_profile_checkpoint >/dev/null && _zsh_profile_checkpoint "zshenv complete"
