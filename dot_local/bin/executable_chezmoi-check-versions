#!/usr/bin/env bash
set -euo pipefail

# chezmoi-check-versions — compare pinned dependency versions against GitHub latest releases
# Usage: chezmoi-check-versions [--force]

CACHE_FILE="$HOME/.cache/chezmoi-version-check.txt"
CACHE_MAX_AGE=86400  # 24 hours in seconds
CHEZMOI_DIR="$HOME/.local/share/chezmoi"

# Return file mtime as epoch seconds. Falls back to 0 when unavailable.
cache_mtime_epoch() {
    local file="$1"
    local mtime

    # GNU stat (Linux)
    mtime="$(stat -c %Y "$file" 2>/dev/null || true)"
    if [[ ! "$mtime" =~ ^[0-9]+$ ]]; then
        # BSD stat (macOS/BSD)
        mtime="$(stat -f %m "$file" 2>/dev/null || true)"
    fi
    if [[ ! "$mtime" =~ ^[0-9]+$ ]]; then
        echo "0"
        return 0
    fi
    echo "$mtime"
}

# Parse args
FORCE=false
if [ "${1:-}" = "--force" ] || [ "${1:-}" = "-f" ]; then
    FORCE=true
fi

# Check cache freshness
if [ "$FORCE" = "false" ] && [ -f "$CACHE_FILE" ]; then
    cache_mtime="$(cache_mtime_epoch "$CACHE_FILE")"
    cache_age=$(( $(date +%s) - cache_mtime ))
    if [ "$cache_age" -lt "$CACHE_MAX_AGE" ]; then
        cat "$CACHE_FILE"
        echo ""
        echo "(cached — use --force to refresh)"
        exit 0
    fi
fi

# Fetch latest GitHub release tag for a repo
# Usage: github_latest_tag "owner/repo"
github_latest_tag() {
    local repo="$1"
    local tag response
    local -a headers=(
        -H "Accept: application/vnd.github+json"
        -H "User-Agent: chezmoi-check-versions"
    )
    if [ -n "${GITHUB_TOKEN:-}" ]; then
        headers+=(-H "Authorization: Bearer $GITHUB_TOKEN")
    fi

    response="$(
        curl -fsSL --retry 2 \
            "${headers[@]}" \
            "https://api.github.com/repos/${repo}/releases/latest" 2>/dev/null || true
    )"

    if [ -z "$response" ]; then
        echo ""
        return 0
    fi

    if command -v jq >/dev/null 2>&1; then
        tag="$(printf '%s' "$response" | jq -r '.tag_name // empty' 2>/dev/null || true)"
    else
        tag="$(printf '%s' "$response" | sed -n 's/.*"tag_name"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' | head -1)"
    fi

    # Strip leading 'v' if present
    echo "${tag#v}"
}

# Extract pinned version from chezmoi config files
# Returns: "version source_file"
get_pinned_nvm() {
    sed -n '/^\[nvm\]/,/^\[/{s/^version = "\([^"]*\)".*/\1/p;}' "$CHEZMOI_DIR/.chezmoidata.toml" | head -1 | sed 's/^v//'
}

get_pinned_fzf() {
    # Check .chezmoiexternal.toml.tmpl for the fzf clone branch tag
    sed -n '/^\["\.local\/share\/fzf"\]/,/^\[/{s/.*"--branch", "\([^"]*\)".*/\1/p;}' "$CHEZMOI_DIR/.chezmoiexternal.toml.tmpl" | head -1 | sed 's/^v//'
}

get_pinned_zsh_syntax_highlighting() {
    # URL contains the tag: .../archive/refs/tags/0.8.0.tar.gz
    sed -n '/zsh-syntax-highlighting/,/refreshPeriod/s|.*refs/tags/\([^"]*\)\.tar\.gz.*|\1|p' \
        "$CHEZMOI_DIR/.chezmoiexternal.toml.tmpl" | head -1 | sed 's/^v//'
}

get_pinned_zsh_autosuggestions() {
    sed -n '/zsh-autosuggestions/,/refreshPeriod/s|.*refs/tags/\([^"]*\)\.tar\.gz.*|\1|p' \
        "$CHEZMOI_DIR/.chezmoiexternal.toml.tmpl" | head -1 | sed 's/^v//'
}

echo "Checking pinned dependency versions against GitHub..."
echo ""

# Build results table
results=""
has_update=false
API_ERROR_COUNT=0

check_dep() {
    local name="$1" pinned="$2" repo="$3"

    if [ -z "$pinned" ]; then
        results="${results}\n| ${name} | (not found) | — | ? |"
        return
    fi

    local latest
    latest=$(github_latest_tag "$repo")

    if [ -z "$latest" ]; then
        results="${results}\n| ${name} | ${pinned} | (API error) | ? |"
        API_ERROR_COUNT=$((API_ERROR_COUNT + 1))
        return
    fi

    if [ "$pinned" = "$latest" ]; then
        results="${results}\n| ${name} | ${pinned} | ${latest} | current |"
    else
        results="${results}\n| ${name} | ${pinned} | ${latest} | UPDATE |"
        has_update=true
    fi
}

check_dep "nvm" "$(get_pinned_nvm)" "nvm-sh/nvm"
check_dep "fzf" "$(get_pinned_fzf)" "junegunn/fzf"
check_dep "zsh-syntax-highlighting" "$(get_pinned_zsh_syntax_highlighting)" "zsh-users/zsh-syntax-highlighting"
check_dep "zsh-autosuggestions" "$(get_pinned_zsh_autosuggestions)" "zsh-users/zsh-autosuggestions"

# Format output
output="| Dependency | Pinned | Latest | Status |
|---|---|---|---|$(echo -e "$results")"

if [ "$has_update" = "true" ]; then
    output="${output}

Updates available! To bump versions automatically:
  chezmoi-bump --check           # Full report (all 13 deps)
  chezmoi-bump <dep> [<dep>...]  # Bump specific deps
  chezmoi-bump --all             # Bump all outdated deps"
fi

if [ "$API_ERROR_COUNT" -gt 0 ]; then
    output="${output}

Check incomplete: ${API_ERROR_COUNT} dependency check(s) failed due to API/network errors.
Tip: set GITHUB_TOKEN to increase GitHub API rate limits, then re-run with --force."
elif [ "$has_update" = "false" ]; then
    output="${output}

All dependencies are up to date."
fi

echo "$output"

# Cache only complete results.
if [ "$API_ERROR_COUNT" -eq 0 ]; then
    mkdir -p "$(dirname "$CACHE_FILE")"
    echo "$output" > "$CACHE_FILE"
fi

# Distinct non-zero exit for incomplete checks caused by API/network errors.
if [ "$API_ERROR_COUNT" -gt 0 ]; then
    exit 2
fi
